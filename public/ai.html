<!DOCTYPE html>
<html>
  <head>
    <title>AI Chat Client</title>
    <style>
      body { 
        margin: 0; 
        padding: 20px; 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background: #f5f5f5;
      }
      
      .config-panel {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
      }
      
      .config-item {
        margin-bottom: 15px;
      }
      
      .config-item label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #333;
      }
      
      .config-item input, .config-item textarea {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 5px;
        box-sizing: border-box;
        font-size: 14px;
      }
      
      .config-item textarea {
        height: 80px;
        resize: vertical;
      }
      
      .slider-container {
        display: flex;
        align-items: center;
        gap: 15px;
      }
      
      .slider {
        flex: 1;
      }
      
      .slider-value {
        font-weight: bold;
        color: #666;
        min-width: 30px;
      }
      
      .toggle-switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
      }
      
      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      
      .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 24px;
      }
      
      .toggle-slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
      }
      
      input:checked + .toggle-slider {
        background-color: #2196F3;
      }
      
      input:checked + .toggle-slider:before {
        transform: translateX(26px);
      }
      
      .control-buttons {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }
      
      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s;
      }
      
      .btn-start {
        background: #4CAF50;
        color: white;
      }
      
      .btn-start:hover {
        background: #45a049;
      }
      
      .btn-stop {
        background: #f44336;
        color: white;
      }
      
      .btn-stop:hover {
        background: #da190b;
      }
      
      .status {
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 10px;
        text-align: center;
        font-weight: bold;
      }
      
      .status.disconnected {
        background: #ffebee;
        color: #c62828;
      }
      
      .status.connected {
        background: #e8f5e8;
        color: #2e7d32;
      }
      
      .chat-container {
        background: white;
        border-radius: 10px;
        height: 400px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
      }
      
      #messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
      }
      
      #messages { 
        list-style-type: none; 
        margin: 0; 
        padding: 0; 
        width: 100%; 
      }
      
      .message-item {
        display: flex;
        align-items: flex-start;
        margin-bottom: 1rem;
        max-width: 70%;
      }
      
      .message-item.me {
        margin-left: auto;
        flex-direction: row-reverse;
      }
      
      .user-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin: 0 10px;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
      }
      
      .robot-icon {
        background-image: url('aiIcon.png');
        background-size: cover;
        background-position: center;
      }
      
      .human-icon {
        background-image: url('userIcon.png');
        background-size: cover;
        background-position: center;
      }
      
      .message-content {
        display: flex;
        flex-direction: column;
      }
      
      .message-item.me .message-content {
        align-items: flex-end;
      }
      
      .username {
        font-size: 0.8rem;
        color: #555;
        margin-bottom: 0.2rem;
      }
      
      .message-bubble {
        padding: 0.5rem 1rem;
        border-radius: 1rem;
        word-wrap: break-word;
        max-width: 100%;
      }
      
      .me .message-bubble {
        background: #dcf8c6;
      }
      
      .other .message-bubble {
        background: #efefef;
      }
      
      .system-message {
        text-align: center;
        color: #888;
        font-style: italic;
        margin: 0.5rem auto;
        font-size: 0.9rem;
      }
    </style>
  </head>
  <body>
    <div class="config-panel">
      <h2>AI Chat Client Configuration</h2>
      
      <div class="config-item">
        <label for="provider">AI Provider:</label>
        <select id="provider">
          <option value="gemini">Google Gemini</option>
          <option value="openai">OpenAI</option>
        </select>
      </div>
      
      <div class="config-item">
        <label for="apiKey" id="apiKeyLabel">Google Gemini API Key:</label>
        <input type="password" id="apiKey" placeholder="Enter your API key">
      </div>
      
      <div class="config-item">
        <label for="systemPrompt">System Prompt:</label>
        <textarea id="systemPrompt" placeholder="Enter system prompt for the AI...">あなたは親しみやすいAIアシスタントです。チャットの会話に自然に参加し、簡潔で有用な回答をしてください。

重要：「調べています」「確認しています」のような中間回答は避け、直接的で完結した回答をしてください。知らない場合は素直に「わかりません」と答えてください。</textarea>
      </div>
      
      <div class="config-item">
        <label for="contextLimit">Context History Limit: <span id="contextValue">25</span></label>
        <div class="slider-container">
          <input type="range" id="contextLimit" class="slider" min="1" max="50" value="25">
        </div>
      </div>
      
      <div class="config-item">
        <label for="maxChats">Maximum Chat Count:</label>
        <input type="number" id="maxChats" value="100" min="1" max="1000">
      </div>
      
      <div class="config-item">
        <label>
          Reply to AI Agents:
          <label class="toggle-switch">
            <input type="checkbox" id="replyToAI">
            <span class="toggle-slider"></span>
          </label>
        </label>
      </div>
      
      <div class="control-buttons">
        <button id="startBtn" class="btn btn-start">Start</button>
        <button id="stopBtn" class="btn btn-stop" style="display: none;">Stop</button>
      </div>
    </div>
    
    <div class="status disconnected" id="status">Disconnected</div>
    
    <div class="chat-container">
      <div id="messages-container">
        <ul id="messages"></ul>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      let socket = null;
      let clientId = null;
      let isRunning = false;
      let chatHistory = [];
      let chatCount = 0;
      let maxChats = 100;
      let lastResponseTime = 0;
      const COOLDOWN_MS = 5000;
      
      // LocalStorage keys
      const STORAGE_KEYS = {
        API_KEY: 'ai_chat_api_key',
        SYSTEM_PROMPT: 'ai_chat_system_prompt',
        PROVIDER: 'ai_chat_provider',
        CONTEXT_LIMIT: 'ai_chat_context_limit',
        MAX_CHATS: 'ai_chat_max_chats',
        REPLY_TO_AI: 'ai_chat_reply_to_ai'
      };
      
      // Configuration elements
      const providerSelect = document.getElementById('provider');
      const apiKeyInput = document.getElementById('apiKey');
      const apiKeyLabel = document.getElementById('apiKeyLabel');
      const systemPromptInput = document.getElementById('systemPrompt');
      const contextLimitInput = document.getElementById('contextLimit');
      const contextValueSpan = document.getElementById('contextValue');
      const maxChatsInput = document.getElementById('maxChats');
      const replyToAIInput = document.getElementById('replyToAI');
      const startBtn = document.getElementById('startBtn');
      const stopBtn = document.getElementById('stopBtn');
      const statusDiv = document.getElementById('status');
      const messagesUl = document.getElementById('messages');

      // Load settings from localStorage
      function loadSettings() {
        const savedApiKey = localStorage.getItem(STORAGE_KEYS.API_KEY);
        const savedSystemPrompt = localStorage.getItem(STORAGE_KEYS.SYSTEM_PROMPT);
        const savedProvider = localStorage.getItem(STORAGE_KEYS.PROVIDER);
        const savedContextLimit = localStorage.getItem(STORAGE_KEYS.CONTEXT_LIMIT);
        const savedMaxChats = localStorage.getItem(STORAGE_KEYS.MAX_CHATS);
        const savedReplyToAI = localStorage.getItem(STORAGE_KEYS.REPLY_TO_AI);

        if (savedApiKey) {
          apiKeyInput.value = savedApiKey;
        }
        
        if (savedSystemPrompt) {
          systemPromptInput.value = savedSystemPrompt;
        }
        
        if (savedProvider) {
          providerSelect.value = savedProvider;
          // Trigger change event to update API key label
          providerSelect.dispatchEvent(new Event('change'));
        }
        
        if (savedContextLimit) {
          contextLimitInput.value = savedContextLimit;
          contextValueSpan.textContent = savedContextLimit;
        }
        
        if (savedMaxChats) {
          maxChatsInput.value = savedMaxChats;
        }
        
        if (savedReplyToAI) {
          replyToAIInput.checked = savedReplyToAI === 'true';
        }
      }

      // Save settings to localStorage
      function saveSettings() {
        localStorage.setItem(STORAGE_KEYS.API_KEY, apiKeyInput.value);
        localStorage.setItem(STORAGE_KEYS.SYSTEM_PROMPT, systemPromptInput.value);
        localStorage.setItem(STORAGE_KEYS.PROVIDER, providerSelect.value);
        localStorage.setItem(STORAGE_KEYS.CONTEXT_LIMIT, contextLimitInput.value);
        localStorage.setItem(STORAGE_KEYS.MAX_CHATS, maxChatsInput.value);
        localStorage.setItem(STORAGE_KEYS.REPLY_TO_AI, replyToAIInput.checked.toString());
      }

      // Initialize settings on page load
      loadSettings();

      // Update context value display
      contextLimitInput.addEventListener('input', (e) => {
        contextValueSpan.textContent = e.target.value;
        saveSettings(); // Save when context limit changes
      });

      // Update API key label when provider changes
      providerSelect.addEventListener('change', (e) => {
        if (e.target.value === 'openai') {
          apiKeyLabel.textContent = 'OpenAI API Key:';
          apiKeyInput.placeholder = 'Enter your OpenAI API key';
        } else {
          apiKeyLabel.textContent = 'Google Gemini API Key:';
          apiKeyInput.placeholder = 'Enter your Gemini API key';
        }
        saveSettings(); // Save when provider changes
      });

      // Save settings when other inputs change
      apiKeyInput.addEventListener('blur', saveSettings);
      systemPromptInput.addEventListener('blur', saveSettings);
      maxChatsInput.addEventListener('blur', saveSettings);
      replyToAIInput.addEventListener('change', saveSettings);

      // Generate AI client ID
      function generateAIClientId() {
        return 'AI-' + Math.random().toString(36).substring(2, 15);
      }

      function getColorFromId(id) {
        let hash = 0;
        for (let i = 0; i < id.length; i++) {
          hash = id.charCodeAt(i) + ((hash << 5) - hash);
        }
        const h = Math.abs(hash % 360);
        return `hsl(${h}, 60%, 65%)`;
      }

      function displaySystemMessage(message) {
        const item = document.createElement('li');
        item.className = 'system-message';
        item.textContent = message;
        messagesUl.appendChild(item);
        scrollToBottom();
      }

      function scrollToBottom() {
        const container = document.getElementById('messages-container');
        container.scrollTop = container.scrollHeight;
      }

      function isAIClient(id) {
        return id.startsWith('AI-');
      }

      function displayChatMessage(data) {
        const item = document.createElement('li');
        item.classList.add('message-item');

        const isMe = data.id === clientId;
        if (isMe) {
          item.classList.add('me');
        } else {
          item.classList.add('other');
        }

        const userIcon = document.createElement('div');
        userIcon.classList.add('user-icon');
        
        if (isAIClient(data.id)) {
          userIcon.classList.add('robot-icon');
        } else {
          userIcon.classList.add('human-icon');
        }
        
        userIcon.style.backgroundColor = getColorFromId(data.id);

        const messageContent = document.createElement('div');
        messageContent.classList.add('message-content');

        const username = document.createElement('div');
        username.classList.add('username');
        username.textContent = data.id.substring(0, 8);

        const messageBubble = document.createElement('div');
        messageBubble.classList.add('message-bubble');
        messageBubble.textContent = data.msg;

        messageContent.appendChild(username);
        messageContent.appendChild(messageBubble);

        item.appendChild(userIcon);
        item.appendChild(messageContent);

        messagesUl.appendChild(item);
        scrollToBottom();

        // Add to chat history
        chatHistory.push(data);
        const contextLimit = parseInt(contextLimitInput.value);
        if (chatHistory.length > contextLimit) {
          chatHistory = chatHistory.slice(-contextLimit);
        }
      }

      async function generateAIResponse(newMessage, retryCount = 0) {
        const apiKey = apiKeyInput.value.trim();
        const systemPrompt = systemPromptInput.value.trim();
        const provider = providerSelect.value;
        const maxRetries = 3;
        
        if (!apiKey) {
          console.error('API key not provided');
          return;
        }

        // Check if we should reply to AI agents
        const shouldReplyToAI = replyToAIInput.checked;
        if (isAIClient(newMessage.id) && !shouldReplyToAI) {
          return;
        }

        // Check max chat count
        if (chatCount >= maxChats) {
          displaySystemMessage('Maximum chat count reached. Stopping...');
          stopAI();
          return;
        }

        try {
          // Prepare context from chat history
          const contextMessages = chatHistory.map(msg => 
            `${msg.id.substring(0, 8)}: ${msg.msg}`
          ).join('\n');

          const prompt = `${systemPrompt}

以下は最近の会話履歴です：
${contextMessages}

最新のメッセージ「${newMessage.id.substring(0, 8)}: ${newMessage.msg}」に対して、自然で簡潔な返信をしてください。`;

          let response, data, aiResponse;

          if (provider === 'openai') {
            response = await fetch('https://api.openai.com/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
              },
              body: JSON.stringify({
                model: 'gpt-4o-mini',
                messages: [
                  { role: 'user', content: prompt }
                ],
                max_tokens: 150,
                temperature: 0.7
              })
            });

            if (!response.ok) {
              throw new Error(`API request failed: ${response.status}`);
            }

            data = await response.json();
            aiResponse = data.choices[0]?.message?.content;
          } else {
            response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                contents: [{
                  parts: [{
                    text: prompt
                  }]
                }]
              })
            });

            if (!response.ok) {
              throw new Error(`API request failed: ${response.status}`);
            }

            data = await response.json();
            aiResponse = data.candidates[0]?.content?.parts[0]?.text;
          }

          if (aiResponse) {
            chatCount++;
            const messageData = { id: clientId, msg: aiResponse.trim() };
            socket.emit('chat message', messageData);
          }
        } catch (error) {
          console.error('Error generating AI response:', error);
          
          // Check for specific error types that warrant retry
          const shouldRetry = (
            error.message.includes('429') || // Rate limit
            error.message.includes('503') || // Service unavailable
            error.message.includes('502') || // Bad gateway
            error.message.includes('504')    // Gateway timeout
          ) && retryCount < maxRetries;

          if (shouldRetry) {
            const delay = Math.min(1000 * Math.pow(2, retryCount), 30000) + Math.random() * 1000;
            displaySystemMessage(`API error (${error.message.includes('429') ? 'rate limit' : 'service unavailable'}). Retrying in ${Math.round(delay/1000)}s... (${retryCount + 1}/${maxRetries})`);
            setTimeout(() => generateAIResponse(newMessage, retryCount + 1), delay);
          } else if (error.message.includes('429')) {
            displaySystemMessage('Rate limit exceeded. Please wait before trying again.');
          } else if (error.message.includes('503')) {
            displaySystemMessage('Gemini API is temporarily unavailable. Please try again later.');
          } else {
            displaySystemMessage(`AI response error: ${error.message}`);
          }
        }
      }

      function startAI() {
        const apiKey = apiKeyInput.value.trim();
        if (!apiKey) {
          alert('Please enter your Gemini API key');
          return;
        }

        isRunning = true;
        clientId = generateAIClientId();
        maxChats = parseInt(maxChatsInput.value);
        chatCount = 0;
        chatHistory = [];

        // Connect to WebSocket
        socket = io();

        socket.emit('user connected', clientId);

        socket.on('welcome', (id) => {
          displaySystemMessage(`AI Agent started - ID: ${id.substring(0, 8)}`);
          statusDiv.textContent = 'Connected';
          statusDiv.className = 'status connected';
        });

        socket.on('user joined', (id) => {
          displaySystemMessage(`ユーザ ${id.substring(0, 8)} が参加しました`);
        });

        socket.on('user left', (id) => {
          displaySystemMessage(`ユーザ ${id.substring(0, 8)} が退出しました`);
        });

        socket.on('chat message', (data) => {
          displayChatMessage(data);

          // Generate AI response if this isn't our own message
          if (data.id !== clientId && isRunning) {
            // Cooldown only applies to AI-to-AI responses (IDs starting with "AI-")
            if (data.id.startsWith('AI-')) {
              const now = Date.now();
              if (now - lastResponseTime < COOLDOWN_MS) {
                console.log(`${clientId} in cooldown, skipping AI response`);
                return;
              }
              lastResponseTime = now;
            }
            
            console.log(`${clientId} will respond to message from ${data.id}: ${data.msg}`);
            setTimeout(() => {
              generateAIResponse(data);
            }, 1000 + Math.random() * 2000); // Random delay 1-3 seconds
          }
        });

        socket.on('disconnect', () => {
          statusDiv.textContent = 'Disconnected';
          statusDiv.className = 'status disconnected';
        });

        startBtn.style.display = 'none';
        stopBtn.style.display = 'inline-block';
      }

      function stopAI() {
        isRunning = false;
        
        if (socket) {
          socket.disconnect();
          socket = null;
        }
        
        statusDiv.textContent = 'Disconnected';
        statusDiv.className = 'status disconnected';
        startBtn.style.display = 'inline-block';
        stopBtn.style.display = 'none';
        
        displaySystemMessage('AI Agent stopped');
      }

      startBtn.addEventListener('click', startAI);
      stopBtn.addEventListener('click', stopAI);
    </script>
  </body>
</html>